<section class="planDetalle">
    <!-- Columna principal: Fotos y comentarios -->
    <section class="planDetalle-main">
        <!-- Galería de fotos -->
        <section class="gallery">
            <div class="gallery-main">
                @if (showSkeleton()) {
                <div class="skeleton skeleton-main"></div>
                } @else {
                <img [src]="selectedImg()" alt="plan-img" class="main-image">
                }
            </div>
            <div class="gallery-thumbs">
                @if (showSkeleton()) {
                @for (let of [1, 2, 3, 4]; track $index) {
                <div class="skeleton skeleton-thumb"></div>
                }
                } @else {
                <div class="thumb" [class.active]="selectedImg() === plan.img" (click)="selectMainImage(plan.img)">
                    <img [src]="plan.img" alt="plan-img">
                </div>
                @for (img of plan.secondary_images; track $index) {
                <div class="thumb" [class.active]="selectedImg() === img.img" (click)="selectMainImage(img.img)">
                    <img [src]="img.img" alt="img">
                </div>
                }
                }
            </div>
        </section>

        <!-- Sección de comentarios -->
        <section class="comments-section">
            <h3 class="comments-title">
                <i class="fa-solid fa-comments"></i>
                Comentarios
            </h3>
            
            @if (logged()) {
            <form class="comment-form" [formGroup]="commentForm" (ngSubmit)="submitComment(commentForm.value)">
                <textarea 
                    placeholder="Añade un comentario..." 
                    formControlName="comment"
                    maxlength="200">
                </textarea>
                <button type="submit" class="btn btn-basico">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>Publicar</span>
                </button>
            </form>
            }

            <div class="comments-list">
                @for (comment of plan.comments; track comment.id) {
                <div class="comment-item" [@commentAnimation]="isNewComment ? 'void' : '*'">
                    <app-comment 
                        (delete)="handleDelete($event)" 
                        [comment]="comment" 
                        [planUserId]="plan.user_id"
                        [sameuser]="sameUser(comment.user.id)">
                    </app-comment>
                </div>
                } @empty {
                <div class="no-comments">
                    <i class="fa-regular fa-comment-dots"></i>
                    <p>Sé el primero en comentar</p>
                </div>
                }
            </div>
        </section>
    </section>

    <!-- Sidebar: Información del plan -->
    <aside class="planDetalle-sidebar">
        <div class="plan-header">
            @if (showSkeleton()) {
            <div class="skeleton skeleton-title"></div>
            } @else {
            <h1>{{plan.name}}</h1>
            }
        </div>

        <div class="plan-user">
            @if (showSkeleton()) {
            <div class="skeleton skeleton-avatar"></div>
            <div class="skeleton skeleton-username"></div>
            } @else {
            <img [src]="plan.user.img" alt="user" class="user-avatar">
            <div class="user-info">
                <span class="label">Publicado por</span>
                <a [routerLink]="['/perfil', plan.user.username]" class="username">{{plan.user.username}}</a>
            </div>
            }
        </div>

        <div class="plan-location">
            @if (showSkeleton()) {
            <div class="skeleton skeleton-text"></div>
            } @else {
            <i class="fa-solid fa-location-dot"></i>
            <span>{{plan.city}}, {{plan.province}}</span>
            }
        </div>

        <div class="plan-actions">
            <button class="action-btn like-btn" (click)="like($event)">
                <img [src]="likeImgBtn()" alt="like">
                <span>{{plan.likes_count}}</span>
            </button>
            <div class="share-buttons">
                <a [href]="whatsappShareUrl" class="share-btn whatsapp" title="Compartir en WhatsApp">
                    <i class="fa-brands fa-whatsapp"></i>
                </a>
                <a [href]="xShareUrl" target="_blank" class="share-btn twitter" title="Compartir en X">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
                <a [href]="facebookShareUrl" target="_blank" class="share-btn facebook" title="Compartir en Facebook">
                    <i class="fa-brands fa-facebook-f"></i>
                </a>
                <button class="share-btn copy" (click)="compartir()" title="Copiar enlace">
                    <i class="fa-solid fa-link"></i>
                </button>
            </div>
        </div>

        <div class="plan-description">
            @if (showSkeleton()) {
            <div class="skeleton skeleton-description"></div>
            } @else {
            <h3>Descripción</h3>
            <p [innerHTML]="plan.description | newlineToBr"></p>
            }
        </div>

        <div class="plan-date">
            <i class="fa-solid fa-clock"></i>
            <span>{{ plan.created_at | dateFormat }}</span>
        </div>

        <app-map [isCreateMode]="false" [planLocation]="coords"/>
    </aside>

    <app-toast-notification />
</section>