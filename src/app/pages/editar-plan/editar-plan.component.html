<section class="publicarPlan">
    <section class="publicarPlan-timeline"></section>
    <section class="publicarPlan-formcont">
        <article class="publicarPlan-formcont-titulo">
            <div class="titulo-content">
                <i class="fa-solid fa-pen-to-square"></i>
                <h2>Editar plan</h2>
            </div>
            <a rel="noopener noreferrer" [routerLink]="linkPerfil" class="btn-volver">
                <i class="fa-solid fa-arrow-left"></i>
                <span>Volver</span>
            </a>
        </article>
        
        <form class="publicarPlan-formcont-form" method="post" [formGroup]="planForm" (submit)="onSubmit(planForm.value)">
            <section class="form-section">
                <div class="section-header">
                    <i class="fa-solid fa-circle-info"></i>
                    <h3>Información básica</h3>
                </div>
                
                <div class="inputContainer">
                    <label for="name">Nombre del plan</label>
                    <input type="text" id="name" placeholder="Ej: Senderismo en Montserrat..." formControlName="name">
                    @if (submitted() && planForm.controls['name'].invalid) {
                    <div class="errorMessage">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        @if (planForm.controls['name'].errors?.['required']) {
                        <span>El nombre es obligatorio</span>
                        }
                    </div>
                    }
                </div>

                <div class="inputContainer">
                    <label for="description">Descripción</label>
                    <textarea id="description" placeholder="Describe tu plan en detalle..." maxlength="700" formControlName="description"></textarea>
                    @if (submitted() && planForm.controls['description'].invalid) {
                    <div class="errorMessage">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        @if (planForm.controls['description'].errors?.['required']) {
                        <span>La descripción es obligatoria</span>
                        }
                    </div>
                    }
                </div>
            </section>

            <section class="form-section">
                <div class="section-header">
                    <i class="fa-solid fa-location-dot"></i>
                    <h3>Ubicación</h3>
                </div>
                
                <div class="location-grid">
                    <div class="inputContainer">
                        <label for="provincia">Provincia</label>
                        <select id="provincia" formControlName="province" (change)="getCoordinates($event)">
                            <option value="" disabled selected>Selecciona una provincia</option>
                            @for (provincia of provincias; track $index) {
                            <option value="{{provincia}}">{{provincia}}</option>
                            }
                        </select>
                        @if (submitted() && planForm.controls['province'].invalid) {
                        <div class="errorMessage">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            @if (planForm.controls['province'].errors?.['required']) {
                            <span>La provincia es obligatoria</span>
                            }
                        </div>
                        }
                    </div>

                    <div class="inputContainer">
                        <label for="city">Ciudad</label>
                        <input type="text" id="city" placeholder="Ej: Barcelona" formControlName="city">
                        @if (submitted() && planForm.controls['city'].invalid) {
                        <div class="errorMessage">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            @if (planForm.controls['city'].errors?.['required']) {
                            <span>La ciudad es obligatoria</span>
                            }
                        </div>
                        }
                    </div>
                </div>

                <div class="inputContainer">
                    <label for="map">Ubicación exacta - Google Maps</label>
                    <div class="map-container">
                        <app-map (exactCoords)="getExactCoordinates($event)" [isCreateMode]="true" [zone]="center" [selected]="getValidCoordinates()" />
                    </div>
                    @if (submitted() && exactCoordinates == null) {
                    <div class="errorMessage">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        <span>La ubicación es obligatoria</span>
                    </div>
                    }
                </div>
            </section>

            <section class="form-section">
                <div class="section-header">
                    <i class="fa-solid fa-layer-group"></i>
                    <h3>Categorías</h3>
                </div>
                
                <div class="inputContainer">
                    <label>Selecciona hasta 3 categorías</label>
                    <div class="categories-grid">
                        @for (categoria of categorias; track $index) {
                        <div class="category-chip" [class.selected]="isCategorySelected(categoria)" (click)="addOrDeleteCategory(categoria)">
                            <span>{{categoria}}</span>
                        </div>
                        }
                    </div>
                    @if (submitted() && planForm.controls['categories'].invalid) {
                    <div class="errorMessage">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        <span>Selecciona hasta 3 categorías</span>
                    </div>
                    }
                </div>
            </section>

            <section class="form-section">
                <div class="section-header">
                    <i class="fa-solid fa-images"></i>
                    <h3>Imágenes</h3>
                </div>
                
                <div class="images-grid">
                    <div class="image-upload-section">
                        <label>Imagen principal</label>
                        <div class="image-preview principal">
                            <img [src]="img()" alt="Imagen principal">
                            <button type="button" class="delete-btn" (click)="deletePrincipal()">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                        <div class="upload-container">
                            <input type="file" id="uploadPrincipal" accept="image/*" (change)="onFileChangePrincipal($event)">
                            <label for="uploadPrincipal" class="upload-button">
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                <span>Subir imagen</span>
                            </label>
                        </div>
                        @if (submitted() && planForm.controls['principal_image'].invalid) {
                        <div class="errorMessage">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            <span>La imagen principal es obligatoria</span>
                        </div>
                        }
                    </div>

                    <div class="image-upload-section">
                        <label>Imágenes secundarias (hasta 4)</label>
                        <div class="secondary-grid">
                            @for (img of secundarias; track $index) {
                            <div class="image-preview secondary">
                                <img [src]="img" alt="Imagen secundaria">
                                <button type="button" class="delete-btn" (click)="deleleteSecundarias($index)">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                            }
                        </div>
                        <div class="upload-container">
                            <input type="file" id="uploadSecundaria" accept="image/*" (change)="onFileChangeSecundaria($event)">
                            <label for="uploadSecundaria" class="upload-button">
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                <span>Subir imagen</span>
                            </label>
                        </div>
                        @if (submitted() && planForm.controls['secondary_images'].invalid) {
                        <div class="errorMessage">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            <span>Alguna imagen no es válida</span>
                        </div>
                        }
                    </div>
                </div>
            </section>

            <div class="submit-container">
                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-floppy-disk"></i>
                    <span>Actualizar plan</span>
                </button>
            </div>
        </form>
    </section>
    <section class="publicarPlan-timeline"></section>
</section>
<app-toast-notification />
